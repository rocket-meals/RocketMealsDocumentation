<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Correctness Verification &#8212; Rocket Meals 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css?v=514cf933" />
    
    <script src="_static/documentation_options.js?v=d45e8c67"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tuning Host Code" href="hostcode.html" />
    <link rel="prev" title="&lt;no title&gt;" href="examples.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="hostcode.html" title="Tuning Host Code"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="examples.html" title="&lt;no title&gt;"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="contents.html">Rocket Meals 0.0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Correctness Verification</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="correctness-verification">
<h1>Correctness Verification<a class="headerlink" href="#correctness-verification" title="Link to this heading">Â¶</a></h1>
<p>Whenever you optimize a program for performance it is very important to
ensure that the program is still producing the correct output. What good
is a program that is fast but not correct?</p>
<p>Therefore an important feature of the kernel tuner is to verify the output
of every kernel instance in the parameter space. To use the kernel tuner
with correctness checking you need to pass the <code class="docutils literal notranslate"><span class="pre">answer</span></code> option to
<code class="docutils literal notranslate"><span class="pre">tune_kernel()</span></code>. Answer is a list that should match the order and types of
the kernel arguments. However, if an argument to the kernel is input-only
you may insert <code class="docutils literal notranslate"><span class="pre">None</span></code> at that location in the list.</p>
<p>After kernel compilation, but before benchmarking the kernel, the kernel
tuner runs the kernel once to verify the output it produces. For each
argument in the <code class="docutils literal notranslate"><span class="pre">answer</span></code> list that is not None, it will check the results
produced by the current kernel against the expected result specified in
<code class="docutils literal notranslate"><span class="pre">answer</span></code>. The comparison is currently implemented using numpy.allclose()
with an maximum allowed absolute error of 1e-6. If you want to use a
difference tolerance value, use the optional argument <code class="docutils literal notranslate"><span class="pre">atol</span></code>.</p>
<p>The example in <code class="docutils literal notranslate"><span class="pre">examples/cuda/convolution_correct.py</span></code> demonstrates how
to use the <code class="docutils literal notranslate"><span class="pre">answer</span></code> option of <code class="docutils literal notranslate"><span class="pre">tune_kernel()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">RocketMealsDocumentation</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;convolution.cu&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos"> 5</span>    <span class="n">kernel_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="n">problem_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="n">size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">problem_size</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="n">input_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">problem_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">problem_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">16</span><span class="p">))</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="linenos">12</span><span class="nb">input</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">input_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="nb">filter</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">17</span><span class="o">*</span><span class="mi">17</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="linenos">15</span><span class="n">cmem_args</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;d_filter&#39;</span><span class="p">:</span> <span class="nb">filter</span> <span class="p">}</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="nb">filter</span><span class="p">]</span>
<span class="linenos">18</span><span class="n">tune_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="linenos">19</span><span class="n">tune_params</span><span class="p">[</span><span class="s2">&quot;block_size_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">)]</span>
<span class="linenos">20</span><span class="n">tune_params</span><span class="p">[</span><span class="s2">&quot;block_size_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="n">tune_params</span><span class="p">[</span><span class="s2">&quot;tile_size_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="linenos">23</span><span class="n">tune_params</span><span class="p">[</span><span class="s2">&quot;tile_size_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="n">grid_div_x</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;block_size_x&quot;</span><span class="p">,</span> <span class="s2">&quot;tile_size_x&quot;</span><span class="p">]</span>
<span class="linenos">26</span><span class="n">grid_div_y</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;block_size_y&quot;</span><span class="p">,</span> <span class="s2">&quot;tile_size_y&quot;</span><span class="p">]</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="c1">#compute the answer using a naive kernel</span>
<span class="linenos">29</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;block_size_x&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;block_size_y&quot;</span><span class="p">:</span> <span class="mi">16</span> <span class="p">}</span>
<span class="linenos">30</span><span class="n">results</span> <span class="o">=</span> <span class="n">RocketMealsDocumentation</span><span class="o">.</span><span class="n">run_kernel</span><span class="p">(</span><span class="s2">&quot;convolution_naive&quot;</span><span class="p">,</span> <span class="n">kernel_string</span><span class="p">,</span>
<span class="linenos">31</span>    <span class="n">problem_size</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
<span class="linenos">32</span>    <span class="n">grid_div_y</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;block_size_y&quot;</span><span class="p">],</span> <span class="n">grid_div_x</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;block_size_x&quot;</span><span class="p">])</span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="c1">#set non-output fields to None</span>
<span class="linenos">35</span><span class="n">answer</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="c1">#start kernel tuning with correctness verification</span>
<span class="linenos">38</span><span class="n">RocketMealsDocumentation</span><span class="o">.</span><span class="n">tune_kernel</span><span class="p">(</span><span class="s2">&quot;convolution_kernel&quot;</span><span class="p">,</span> <span class="n">kernel_string</span><span class="p">,</span>
<span class="linenos">39</span>    <span class="n">problem_size</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tune_params</span><span class="p">,</span>
<span class="linenos">40</span>    <span class="n">grid_div_y</span><span class="o">=</span><span class="n">grid_div_y</span><span class="p">,</span> <span class="n">grid_div_x</span><span class="o">=</span><span class="n">grid_div_x</span><span class="p">,</span>
<span class="linenos">41</span>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmem_args</span><span class="o">=</span><span class="n">cmem_args</span><span class="p">,</span> <span class="n">answer</span><span class="o">=</span><span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
<p>This example uses the <code class="docutils literal notranslate"><span class="pre">run_kernel()</span></code> function of the kernel tuner
to run a single kernel and return its results, with almost the same
interface as <code class="docutils literal notranslate"><span class="pre">tune_kernel()</span></code>. In this example we run a naive CUDA
kernel whose results are trusted to be correct.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">answer</span></code> list is constructed out of the results from the naive
kernel, but only includes the kernel arguments that are actually outputs.
The arguments that are input are replaced by a <code class="docutils literal notranslate"><span class="pre">None</span></code> value in the
<code class="docutils literal notranslate"><span class="pre">answer</span></code> list before the list is passed to <code class="docutils literal notranslate"><span class="pre">tune_kernel()</span></code>.</p>
<p>There are cases, however, where simply comparing the results computed on the device to precomputed values is not enough,
and more flexibility is necessary.
In this case, it is possible to use the <code class="docutils literal notranslate"><span class="pre">verify</span></code> option of <code class="docutils literal notranslate"><span class="pre">tune_kernel()</span></code> and specify a <code class="docutils literal notranslate"><span class="pre">callable</span></code> object that
implements a user-defined correctness check.
This function should accept three parameters: <code class="docutils literal notranslate"><span class="pre">cpu_result</span></code>, <code class="docutils literal notranslate"><span class="pre">gpu_result</span></code>, and <code class="docutils literal notranslate"><span class="pre">atol</span></code>.
Although the name of the parameters can be different, their semantic is position dependent and reflected in the names
used in the documentation.</p>
<p>The example in <code class="docutils literal notranslate"><span class="pre">examples/cuda/reduction.py</span></code> demonstrates how to use the <code class="docutils literal notranslate"><span class="pre">verify</span></code> option of <code class="docutils literal notranslate"><span class="pre">tune_kernel()</span></code>;
what follows is a snippet from the example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># gpu_result</span>
<span class="linenos"> 2</span><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">sum_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
<span class="linenos"> 3</span><span class="c1"># cpu_result</span>
<span class="linenos"> 4</span><span class="n">reference</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos"> 5</span><span class="c1"># custom verify function</span>
<span class="linenos"> 6</span><span class="k">def</span> <span class="nf">verify_partial_reduce</span><span class="p">(</span><span class="n">cpu_result</span><span class="p">,</span> <span class="n">gpu_result</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 7</span>    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">cpu_result</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gpu_result</span><span class="p">),</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="c1"># call to tune_kernel()</span>
<span class="linenos"> 9</span><span class="n">first_kernel</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tune_kernel</span><span class="p">(</span><span class="s2">&quot;sum_floats&quot;</span><span class="p">,</span> <span class="n">kernel_string</span><span class="p">,</span> <span class="n">problem_size</span><span class="p">,</span>
<span class="linenos">10</span>    <span class="n">args</span><span class="p">,</span> <span class="n">tune_params</span><span class="p">,</span> <span class="n">grid_div_x</span><span class="o">=</span><span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">answer</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="n">verify_partial_reduce</span><span class="p">)</span>
</pre></div>
</div>
<p>The first argument, <code class="docutils literal notranslate"><span class="pre">cpu_result</span></code>, is mapped to the NumPy array provided to the <code class="docutils literal notranslate"><span class="pre">answer</span></code> option; in this example it
is mapped to <code class="docutils literal notranslate"><span class="pre">reference</span></code>.
The second argument, <code class="docutils literal notranslate"><span class="pre">gpu_result</span></code>, is mapped to the NumPy array provided to the <code class="docutils literal notranslate"><span class="pre">arguments</span></code> option of
<code class="docutils literal notranslate"><span class="pre">tune_kernel()</span></code>; in this example it is mapped to <code class="docutils literal notranslate"><span class="pre">args</span></code>.
The third argument, <code class="docutils literal notranslate"><span class="pre">atol</span></code>, is set to <code class="docutils literal notranslate"><span class="pre">None</span></code>; the default maximum allowed absolute error of 1e-6 is then used.</p>
<p>In the example, the user-defined <code class="docutils literal notranslate"><span class="pre">verify</span></code> function is used to compare the partial results, computed on the GPU,
to the final result, computed on the CPU.
The same could not be achieved just by using the <code class="docutils literal notranslate"><span class="pre">answer</span></code> option, because the number of elements in <code class="docutils literal notranslate"><span class="pre">args[0]</span></code> does
not necessarily match the number of elements in <code class="docutils literal notranslate"><span class="pre">reference[0]</span></code> in this example.</p>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="contents.html">
              <img class="logo" src="_static/logo.png" alt="Logo"/>
            </a></p>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="examples.html"
                          title="previous chapter">&lt;no title&gt;</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="hostcode.html"
                          title="next chapter">Tuning Host Code</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/correctness.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="hostcode.html" title="Tuning Host Code"
             >next</a> |</li>
        <li class="right" >
          <a href="examples.html" title="&lt;no title&gt;"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="contents.html">Rocket Meals 0.0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Correctness Verification</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2016, Baumgartner Software.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.2.
    </div>
  </body>
</html>